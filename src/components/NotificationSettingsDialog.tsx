"use client";

import { useEffect, useState } from "react";
import { createClient } from "@/lib/supabase-client";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import {
  ArrowLeft,
  Save,
  Info,
  Clock,
  Plus,
  Copy,
  Trash2,
  Settings,
  Calendar,
} from "lucide-react";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { UnifiedDatePicker } from "@/components/ui/unified-date-picker";
import { LunarService } from "@/lib/lunarService";
import { addDays, format } from "date-fns";
import { type EventTemplate } from "./TemplateSelectionDialog";
import { type EventInfo } from "./EventInfoDialog";
import { type LunarDate } from "@/components/ui/lunar-date-picker";
import toast from "react-hot-toast";

// Enum cho lo·∫°i notification
type NotificationType = "solar" | "lunar";

interface NotificationSetting {
  type: NotificationType; // 'solar' ho·∫∑c 'lunar'
  advanceDays: number;
  note: string;
  providerId: string;

  // Solar notification fields
  solarDate?: string; // ISO date string

  // Lunar notification fields
  lunarDate?: LunarDate;

  isAutoGenerated?: boolean;

  // Th√™m field ƒë·ªÉ control hi·ªÉn th·ªã t√πy ch·ªânh ng√†y
  isCustomDateEnabled?: boolean;

  // Th√™m field ƒë·ªÉ control nh·∫Øc l·∫°i h√†ng nƒÉm theo √¢m l·ªãch
  isYearlyLunarRepeat?: boolean;
}

interface NotificationSettingsDialogProps {
  isOpen: boolean;
  onClose: () => void;
  onBack: () => void;
  onComplete: () => void;
  templateData: EventTemplate | null;
  eventInfo: EventInfo;
}

export function NotificationSettingsDialog({
  isOpen,
  onClose,
  onBack,
  onComplete,
  templateData,
  eventInfo,
}: NotificationSettingsDialogProps) {
  const [notifications, setNotifications] = useState<NotificationSetting[]>([]);
  const [providers, setProviders] = useState<
    Array<{ id: string; name: string; is_default: boolean }>
  >([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const supabase = createClient();

  // Load providers
  useEffect(() => {
    (async () => {
      try {
        const {
          data: { user },
        } = await supabase.auth.getUser();
        if (!user) return;

        const { data, error } = await supabase
          .from("notification_providers")
          .select("id, name, is_default")
          .eq("user_id", user.id)
          .order("is_default", { ascending: false });

        if (!error && data) {
          setProviders(data);
        }
      } catch (e) {
        console.error("Load providers error", e);
      }
    })();
  }, [supabase]);

  // Auto-generate notifications t·ª´ template
  useEffect(() => {
    if (isOpen && templateData && eventInfo && providers.length > 0) {
      generateNotifications();
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isOpen, templateData, eventInfo, providers]);

  const generateNotifications = () => {
    const defaultProvider = providers.find((p) => p.is_default);
    const defaultProviderId = defaultProvider?.id || "";
    const generatedNotifications: NotificationSetting[] = [];

    // üö´ KH√îNG t·∫°o main notification m·∫∑c ƒë·ªãnh n·ªØa ƒë·ªÉ tr√°nh confuse
    // Main notification s·∫Ω ƒë·ªÉ user t·ª± t·∫°o n·∫øu mu·ªën

    // ‚úÖ V·∫™N t·∫°o template notifications theo template ƒë√£ ch·ªçn
    if (templateData?.notifySettings) {
      templateData.notifySettings.forEach((templateNotif) => {
        // üî¥ M·ªöI: D√πng tr·ª±c ti·∫øp advanceDays t·ª´ template, kh√¥ng c·ªông th√™m preferredAdvanceDays
        generatedNotifications.push({
          type: eventInfo.isLunar ? "lunar" : "solar",
          advanceDays: templateNotif.advanceDays,
          note: templateNotif.note || `${eventInfo.title}`,
          providerId: defaultProviderId,
          solarDate: eventInfo.isLunar ? undefined : eventInfo.solarDate,
          lunarDate: eventInfo.isLunar
            ? {
                day: Number(eventInfo.lunarDay),
                month: Number(eventInfo.lunarMonth),
                year: eventInfo.lunarYear
                  ? Number(eventInfo.lunarYear)
                  : new Date().getFullYear(),
                isLeapMonth: eventInfo.isLeapMonth,
              }
            : undefined,
          isAutoGenerated: true,
          isCustomDateEnabled: false,
          // üî¥ D√πng setting t·ª´ template, fallback v·ªÅ setting event
          isYearlyLunarRepeat:
            templateNotif.isYearlyLunarRepeat !== undefined
              ? templateNotif.isYearlyLunarRepeat
              : eventInfo.isLunar && eventInfo.repeatYearly,
        });
      });
    }

    setNotifications(generatedNotifications);
  };

  // Th√™m notification m·ªõi
  const addNotification = () => {
    const defaultProvider = providers.find((p) => p.is_default);
    const today = new Date();
    const currentLunar = LunarService.getTodayLunarDate();

    setNotifications((prev) => [
      ...prev,
      {
        type: "solar" as NotificationType, // M·∫∑c ƒë·ªãnh solar
        advanceDays: 1,
        note: "",
        providerId: defaultProvider?.id || "",
        solarDate: today.toISOString().split("T")[0],
        lunarDate: {
          ...currentLunar,
          isLeapMonth: currentLunar.isLeapMonth || false,
        },
        isAutoGenerated: false,
        isCustomDateEnabled: false, // M·∫∑c ƒë·ªãnh t·∫Øt t√πy ch·ªânh ng√†y
        isYearlyLunarRepeat: false, // M·∫∑c ƒë·ªãnh t·∫Øt l·∫∑p l·∫°i h√†ng nƒÉm
      },
    ]);
  };

  // Nh√¢n b·∫£n notification
  const duplicateNotification = (index: number) => {
    const notification = notifications[index];
    setNotifications((prev) => [
      ...prev,
      {
        ...notification,
        isAutoGenerated: false,
        isCustomDateEnabled: notification.isCustomDateEnabled || false, // Copy setting t√πy ch·ªânh
        isYearlyLunarRepeat: notification.isYearlyLunarRepeat || false, // Copy setting l·∫∑p l·∫°i
      },
    ]);
  };

  // X√≥a notification
  const removeNotification = (index: number) => {
    setNotifications((prev) => prev.filter((_, i) => i !== index));
  };

  // Calculate notification date ƒë·ªÉ preview
  const calculateNotificationDate = (
    notification: NotificationSetting
  ): Date => {
    let baseDate: Date;

    // N·∫øu kh√¥ng b·∫≠t t√πy ch·ªânh ng√†y, d√πng ng√†y g·ªëc c·ªßa event v·ªõi logic th√¥ng minh
    if (!notification.isCustomDateEnabled) {
      // üî¥ M·ªöI: S·ª≠ d·ª•ng h√†m calculateNotificationBaseDate v·ªõi logic 4 tr∆∞·ªùng h·ª£p
      baseDate = LunarService.calculateNotificationBaseDate(
        eventInfo,
        notification.isYearlyLunarRepeat || false
      );
    } else {
      // D√πng ng√†y t√πy ch·ªânh - logic t∆∞∆°ng t·ª± nh∆∞ng v·ªõi custom event info
      if (notification.type === "solar") {
        if (notification.solarDate) {
          const customEventInfo = {
            isLunar: false,
            lunarDay: "" as const,
            lunarMonth: "" as const,
            lunarYear: "" as const,
            isLeapMonth: false,
            solarDate: notification.solarDate,
          };
          baseDate = LunarService.calculateNotificationBaseDate(
            customEventInfo,
            notification.isYearlyLunarRepeat || false
          );
        } else {
          baseDate = new Date();
        }
      } else {
        // Lunar notification v·ªõi custom date
        const lunarDate = notification.lunarDate;
        if (lunarDate && lunarDate.day && lunarDate.month) {
          const customEventInfo = {
            isLunar: true,
            lunarDay: lunarDate.day,
            lunarMonth: lunarDate.month,
            lunarYear: lunarDate.year || new Date().getFullYear(),
            isLeapMonth: lunarDate.isLeapMonth || false,
            solarDate: "",
          };
          baseDate = LunarService.calculateNotificationBaseDate(
            customEventInfo,
            notification.isYearlyLunarRepeat || false
          );
        } else {
          baseDate = new Date();
        }
      }
    }

    // ‚ö†Ô∏è Logic m·ªõi:
    // - advanceDays d∆∞∆°ng (+): nh·∫Øc tr∆∞·ªõc s·ª± ki·ªán ‚Üí baseDate - advanceDays
    // - advanceDays √¢m (-): nh·∫Øc sau s·ª± ki·ªán ‚Üí baseDate - (-advanceDays) = baseDate + advanceDays
    // - advanceDays = 0: nh·∫Øc ƒë√∫ng ng√†y s·ª± ki·ªán ‚Üí baseDate
    return addDays(baseDate, -notification.advanceDays);
  };

  const handleSave = async () => {
    setError(null);
    setLoading(true);

    const {
      data: { user },
    } = await supabase.auth.getUser();

    if (!user) {
      setError("C·∫ßn ƒëƒÉng nh·∫≠p");
      setLoading(false);
      return;
    }

    try {
      // Create main event (t·ª´ eventInfo)
      const eventPayload: any = {
        user_id: user.id,
        title: eventInfo.title,
        description: eventInfo.description || null,
        event_type: eventInfo.isLunar ? "lunar" : "solar",
      };

      if (eventInfo.isLunar) {
        eventPayload.lunar_day = Number(eventInfo.lunarDay);
        eventPayload.lunar_month = Number(eventInfo.lunarMonth);
        eventPayload.lunar_year = eventInfo.lunarYear
          ? Number(eventInfo.lunarYear)
          : null;
        eventPayload.is_leap_month = eventInfo.isLeapMonth;

        // Pre-convert solar date cho lunar event
        try {
          const solarDate = LunarService.convertLunarToSolar(
            Number(eventInfo.lunarDay),
            Number(eventInfo.lunarMonth),
            eventInfo.lunarYear
              ? Number(eventInfo.lunarYear)
              : new Date().getFullYear(),
            eventInfo.isLeapMonth
          );
          eventPayload.solar_converted_date = solarDate
            .toISOString()
            .split("T")[0];
          eventPayload.conversion_metadata = {
            source_lunar: {
              day: Number(eventInfo.lunarDay),
              month: Number(eventInfo.lunarMonth),
              is_leap_month: eventInfo.isLeapMonth,
            },
            converted_for_year: new Date().getFullYear(),
            converted_at: new Date().toISOString(),
            is_valid: true,
          };
        } catch (error) {
          console.error("L·ªói convert lunar to solar:", error);
        }
      } else {
        eventPayload.solar_date = eventInfo.solarDate;
      }

      const { data: eventData, error: eventError } = await supabase
        .from("events")
        .insert(eventPayload)
        .select("id")
        .single();

      if (eventError) {
        setError(eventError.message);
        setLoading(false);
        return;
      }

      // Create notification events ri√™ng cho m·ªói notification setting
      const eventId = eventData.id;

      for (const notification of notifications) {
        if (notification.providerId) {
          // T·∫°o notification event ri√™ng cho m·ªói notification
          let notificationEventPayload: any = {
            user_id: user.id,
            title: `üîî ${notification.note || eventInfo.title}`,
            description: `Th√¥ng b√°o cho: ${eventInfo.title}`,
            event_type: notification.type,
            preferred_advance_days: 0, // Notification event kh√¥ng c·∫ßn advance
          };

          if (notification.type === "solar") {
            notificationEventPayload.solar_date = notification.solarDate;
          } else {
            const lunarDate = notification.lunarDate!;
            notificationEventPayload.lunar_day = lunarDate.day;
            notificationEventPayload.lunar_month = lunarDate.month;
            notificationEventPayload.lunar_year = lunarDate.year;
            notificationEventPayload.is_leap_month = lunarDate.isLeapMonth;

            // Pre-convert cho lunar notification
            try {
              const solarDate = LunarService.convertLunarToSolar(
                lunarDate.day,
                lunarDate.month,
                lunarDate.year,
                lunarDate.isLeapMonth
              );
              notificationEventPayload.solar_converted_date = solarDate
                .toISOString()
                .split("T")[0];
              notificationEventPayload.conversion_metadata = {
                source_lunar: {
                  day: lunarDate.day,
                  month: lunarDate.month,
                  is_leap_month: lunarDate.isLeapMonth,
                },
                converted_for_year: new Date().getFullYear(),
                converted_at: new Date().toISOString(),
                is_valid: true,
              };
            } catch (error) {
              console.error("L·ªói convert notification lunar to solar:", error);
            }
          }

          const { data: notificationEventData, error: notificationEventError } =
            await supabase
              .from("events")
              .insert(notificationEventPayload)
              .select("id")
              .single();

          if (!notificationEventError && notificationEventData) {
            // T·∫°o notification setting link t·ªõi notification event
            await supabase.from("notification_settings").insert({
              user_id: user.id,
              event_id: notificationEventData.id,
              channel: "app", // Default channel
              advance_days: 0, // Notification event s·∫Ω trigger ƒë√∫ng ng√†y
              provider_id: notification.providerId,
              note: notification.note || null,
              lunar_repeat_yearly: notification.isYearlyLunarRepeat || false, // L∆∞u setting l·∫∑p l·∫°i v√†o notification_settings
            });
          }
        }
      }

      toast.success("ƒê√£ t·∫°o s·ª± ki·ªán v√† th√¥ng b√°o th√†nh c√¥ng!");
      onComplete();
    } catch (error) {
      console.error("Error saving:", error);
      setError("ƒê√£ c√≥ l·ªói x·∫£y ra khi l∆∞u");
      setLoading(false);
    }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <Card
        className="rounded-lg shadow-xl w-full max-w-5xl max-h-[90vh] overflow-y-auto"
        onClick={(e) => e.stopPropagation()}
      >
        <CardHeader>
          <div className="flex items-center justify-between">
            <CardTitle className="flex items-center gap-3 text-2xl text-purple-800 dark:text-purple-500">
              <Clock className="h-8 w-8 text-purple-600 dark:text-purple-400" />
              <span>C√†i ƒë·∫∑t th√¥ng b√°o</span>
            </CardTitle>
            <button
              onClick={onClose}
              className="text-muted-foreground hover:text-foreground p-1 rounded-full hover:bg-accent"
            >
              ‚úï
            </button>
          </div>

          <div className="mt-4 flex items-center justify-center gap-2">
            <div className="w-3 h-3 rounded-full bg-green-500"></div>
            <div className="w-8 h-1 bg-green-500"></div>
            <div className="w-3 h-3 rounded-full bg-green-500"></div>
            <div className="w-8 h-1 bg-purple-500"></div>
            <div className="w-3 h-3 rounded-full bg-purple-500"></div>
            <div className="text-xs text-muted-foreground ml-2">
              B∆∞·ªõc 3/3: C√†i ƒë·∫∑t th√¥ng b√°o
            </div>
          </div>

          <div className="mt-4 p-4 bg-muted/50 rounded-lg">
            <h4 className="font-medium text-foreground mb-2">
              üìÖ S·ª± ki·ªán: {eventInfo.title}
            </h4>
            <div className="text-sm text-muted-foreground space-y-2">
              {eventInfo.isLunar ? (
                <>
                  <div className="flex items-center gap-2">
                    <span>üåô</span>
                    <span>
                      Ng√†y {eventInfo.lunarDay}/{eventInfo.lunarMonth} √Çm l·ªãch{" "}
                      {eventInfo.lunarYear && `nƒÉm ${eventInfo.lunarYear}`}
                      {eventInfo.isLeapMonth && " (nhu·∫≠n)"}
                    </span>
                  </div>
                  {/* Hi·ªÉn th·ªã ng√†y d∆∞∆°ng t∆∞∆°ng ƒë∆∞∆°ng */}
                  {(() => {
                    try {
                      const solarConverted = LunarService.convertLunarToSolar(
                        Number(eventInfo.lunarDay),
                        Number(eventInfo.lunarMonth),
                        eventInfo.lunarYear
                          ? Number(eventInfo.lunarYear)
                          : new Date().getFullYear(),
                        eventInfo.isLeapMonth || false
                      );
                      return (
                        <div className="flex items-center gap-2 text-xs text-blue-600 dark:text-blue-400 ml-6">
                          <span>‚Ü≥ ‚òÄÔ∏è</span>
                          <span>
                            T∆∞∆°ng ƒë∆∞∆°ng: {format(solarConverted, "dd/MM/yyyy")}{" "}
                            D∆∞∆°ng l·ªãch
                          </span>
                        </div>
                      );
                    } catch {
                      return (
                        <div className="flex items-center gap-2 text-xs text-orange-600 dark:text-orange-400 ml-6">
                          <span>‚ö†Ô∏è</span>
                          <span>Kh√¥ng th·ªÉ chuy·ªÉn ƒë·ªïi sang d∆∞∆°ng l·ªãch</span>
                        </div>
                      );
                    }
                  })()}
                </>
              ) : (
                <>
                  <div className="flex items-center gap-2">
                    <span>‚òÄÔ∏è</span>
                    <span>
                      Ng√†y {format(new Date(eventInfo.solarDate), "dd/MM/yyyy")}{" "}
                      D∆∞∆°ng l·ªãch
                    </span>
                  </div>
                  {/* Hi·ªÉn th·ªã ng√†y √¢m t∆∞∆°ng ƒë∆∞∆°ng */}
                  {(() => {
                    try {
                      const lunarConverted = LunarService.convertSolarToLunar(
                        new Date(eventInfo.solarDate)
                      );
                      return (
                        <div className="flex items-center gap-2 text-xs text-purple-600 dark:text-purple-400 ml-6">
                          <span>‚Ü≥ üåô</span>
                          <span>
                            T∆∞∆°ng ƒë∆∞∆°ng: {lunarConverted.day}/
                            {lunarConverted.month} √Çm l·ªãch
                            {lunarConverted.isLeapMonth ? " (nhu·∫≠n)" : ""}
                          </span>
                        </div>
                      );
                    } catch {
                      return (
                        <div className="flex items-center gap-2 text-xs text-orange-600 dark:text-orange-400 ml-6">
                          <span>‚ö†Ô∏è</span>
                          <span>Kh√¥ng th·ªÉ chuy·ªÉn ƒë·ªïi sang √¢m l·ªãch</span>
                        </div>
                      );
                    }
                  })()}
                </>
              )}

              <div className="pt-1 border-t border-muted/50">
                <p>
                  üì° K√™nh th√¥ng b√°o:{" "}
                  {providers.find((p) => p.is_default)?.name ||
                    "Ch∆∞a c√≥ k√™nh th√¥ng b√°o n√†o"}
                </p>
              </div>
            </div>
          </div>
        </CardHeader>

        <CardContent>
          <div className="space-y-6">
            <div className="p-3 bg-purple-50 dark:bg-purple-950 rounded-lg border-l-4 border-purple-400 dark:border-purple-600">
              <div className="flex items-start gap-2">
                <Info className="h-4 w-4 text-purple-600 dark:text-purple-400 mt-0.5 flex-shrink-0" />
                <div className="text-sm text-purple-800 dark:text-purple-200">
                  <p className="font-medium">Th√¥ng b√°o linh ho·∫°t</p>
                  <p className="text-xs mt-1">
                    M·ªói th√¥ng b√°o c√≥ th·ªÉ l√† d∆∞∆°ng l·ªãch (ng√†y c·ªë ƒë·ªãnh) ho·∫∑c √¢m
                    l·ªãch (l·∫∑p h√†ng nƒÉm theo √¢m l·ªãch).
                  </p>
                </div>
              </div>
            </div>

            <div className="space-y-4">
              <div className="flex justify-between items-center">
                <h3 className="font-medium text-foreground">
                  Danh s√°ch th√¥ng b√°o s·∫Ω ƒë∆∞·ª£c t·∫°o
                </h3>
                <Button
                  type="button"
                  variant="outline"
                  size="sm"
                  onClick={addNotification}
                  className="flex items-center gap-2"
                >
                  <Plus className="h-4 w-4" />
                  Th√™m th√¥ng b√°o
                </Button>
              </div>

              {notifications.length === 0 ? (
                <div className="text-center py-12 text-muted-foreground">
                  <Clock className="h-16 w-16 mx-auto mb-4 opacity-30" />
                  <h3 className="text-lg font-medium mb-2">
                    {templateData
                      ? `Template "${templateData.name}" kh√¥ng c√≥ th√¥ng b√°o t·ª± ƒë·ªông`
                      : "Ch∆∞a c√≥ th√¥ng b√°o n√†o"}
                  </h3>
                  <p className="text-sm mb-4">
                    {templateData
                      ? "B·∫°n c√≥ th·ªÉ t·ª± t·∫°o th√¥ng b√°o t√πy ch·ªânh cho s·ª± ki·ªán n√†y"
                      : "B·∫°n c√≥ th·ªÉ t·∫°o th√¥ng b√°o t√πy ch·ªânh cho s·ª± ki·ªán n√†y"}
                  </p>
                  <div className="inline-flex items-center gap-2 px-3 py-1 bg-purple-50 dark:bg-purple-950 rounded-lg text-purple-700 dark:text-purple-300 text-xs">
                    üí° Click "Th√™m th√¥ng b√°o" ƒë·ªÉ b·∫Øt ƒë·∫ßu
                  </div>
                </div>
              ) : (
                notifications.map((notification, index) => {
                  const notificationDate =
                    calculateNotificationDate(notification);

                  return (
                    <div
                      key={index}
                      className="border rounded-md p-4 bg-purple-50/30 dark:bg-purple-950/20 border-purple-200 dark:border-purple-800 relative"
                    >
                      {/* Action buttons */}
                      <div className="absolute top-2 right-2 flex gap-1">
                        <button
                          type="button"
                          className="text-muted-foreground hover:text-foreground p-1 rounded hover:bg-accent"
                          onClick={() => duplicateNotification(index)}
                          title="Nh√¢n b·∫£n th√¥ng b√°o n√†y"
                        >
                          <Copy className="h-4 w-4" />
                        </button>
                        <button
                          type="button"
                          className="text-red-500 hover:text-red-600 dark:text-red-400 dark:hover:text-red-500 p-1 rounded hover:bg-accent"
                          onClick={() => removeNotification(index)}
                          title="X√≥a th√¥ng b√°o n√†y"
                        >
                          <Trash2 className="h-4 w-4" />
                        </button>
                      </div>

                      <div className="space-y-4 mt-6">
                        {/* Switch t√πy ch·ªânh ng√†y */}
                        <div className="space-y-2">
                          <div className="flex items-center justify-between p-3 bg-muted/20 rounded-lg border">
                            <div className="flex items-center gap-2">
                              <Settings className="h-4 w-4 text-muted-foreground" />
                              <Label className="text-sm font-medium">
                                T√πy ch·ªânh ng√†y th√¥ng b√°o
                              </Label>
                            </div>
                            <label className="relative inline-flex items-center cursor-pointer">
                              <input
                                type="checkbox"
                                checked={
                                  notification.isCustomDateEnabled || false
                                }
                                onChange={(e) => {
                                  setNotifications((prev) => {
                                    const copy = [...prev];
                                    copy[index] = {
                                      ...copy[index],
                                      isCustomDateEnabled: e.target.checked,
                                    };
                                    return copy;
                                  });
                                }}
                                className="sr-only peer"
                              />
                              <div className="w-11 h-6 bg-input peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 dark:peer-focus:ring-purple-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-background after:border-border after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                            </label>
                          </div>

                          {!notification.isCustomDateEnabled && (
                            <p className="text-xs text-muted-foreground px-3">
                              üìÖ Th√¥ng b√°o n√†y s·∫Ω d·ª±a v√†o ng√†y s·ª± ki·ªán g·ªëc
                              {notification.advanceDays > 0
                                ? ` - ${notification.advanceDays} ng√†y (tr∆∞·ªõc s·ª± ki·ªán)`
                                : notification.advanceDays < 0
                                  ? ` + ${Math.abs(notification.advanceDays)} ng√†y (sau s·ª± ki·ªán)`
                                  : " (ƒë√∫ng ng√†y s·ª± ki·ªán)"}
                            </p>
                          )}
                        </div>

                        {/* Switch nh·∫Øc l·∫°i h√†ng nƒÉm theo √¢m l·ªãch */}
                        <div className="space-y-2">
                          <div className="flex items-center justify-between p-3 bg-red-50/30 dark:bg-red-950/20 rounded-lg border border-red-200 dark:border-red-800">
                            <div className="flex items-center gap-2">
                              <Calendar className="h-4 w-4 text-red-600 dark:text-red-400" />
                              <Label className="text-sm font-medium">
                                Nh·∫Øc l·∫°i h√†ng nƒÉm theo √¢m l·ªãch
                              </Label>
                            </div>
                            <label className="relative inline-flex items-center cursor-pointer">
                              <input
                                type="checkbox"
                                checked={
                                  notification.isYearlyLunarRepeat || false
                                }
                                onChange={(e) => {
                                  setNotifications((prev) => {
                                    const copy = [...prev];
                                    copy[index] = {
                                      ...copy[index],
                                      isYearlyLunarRepeat: e.target.checked,
                                    };
                                    return copy;
                                  });
                                }}
                                className="sr-only peer"
                              />
                              <div className="w-11 h-6 bg-input peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-300 dark:peer-focus:ring-red-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-background after:border-border after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                            </label>
                          </div>

                          {notification.isYearlyLunarRepeat && (
                            <p className="text-xs text-red-600 dark:text-red-400 px-3">
                              üåô Th√¥ng b√°o n√†y s·∫Ω l·∫∑p l·∫°i h√†ng nƒÉm theo √¢m l·ªãch
                              t·ª± ƒë·ªông. Ng√†y th√¥ng b√°o k·∫ø ti·∫øp s·∫Ω ƒë∆∞·ª£c th√™m v√†o
                              th√¥ng b√°o nh·∫≠n ƒë∆∞·ª£c.
                            </p>
                          )}

                          {!notification.isYearlyLunarRepeat && (
                            <p className="text-xs text-muted-foreground px-3">
                              üìÖ Th√¥ng b√°o n√†y ch·ªâ di·ªÖn ra 1 l·∫ßn nh∆∞ preview.
                            </p>
                          )}
                        </div>

                        {/* Hi·ªÉn th·ªã UnifiedDatePicker khi ƒë∆∞·ª£c b·∫≠t */}
                        {notification.isCustomDateEnabled && (
                          <UnifiedDatePicker
                            isLunar={notification.type === "lunar"}
                            onToggleLunar={(isLunar) => {
                              setNotifications((prev) => {
                                const copy = [...prev];
                                copy[index] = {
                                  ...copy[index],
                                  type: isLunar ? "lunar" : "solar",
                                };
                                return copy;
                              });
                            }}
                            solarDate={notification.solarDate || ""}
                            onSolarDateChange={(date) => {
                              setNotifications((prev) => {
                                const copy = [...prev];
                                copy[index] = {
                                  ...copy[index],
                                  solarDate: date,
                                };
                                return copy;
                              });
                            }}
                            lunarDate={{
                              day: notification.lunarDate?.day || 1,
                              month: notification.lunarDate?.month || 1,
                              year:
                                notification.lunarDate?.year ||
                                new Date().getFullYear(),
                              isLeapMonth:
                                notification.lunarDate?.isLeapMonth || false,
                            }}
                            onLunarDateChange={(lunarDate) => {
                              setNotifications((prev) => {
                                const copy = [...prev];
                                copy[index] = {
                                  ...copy[index],
                                  lunarDate: {
                                    day: lunarDate.day,
                                    month: lunarDate.month,
                                    year: lunarDate.year,
                                    isLeapMonth: lunarDate.isLeapMonth || false,
                                  },
                                };
                                return copy;
                              });
                            }}
                            showGuidance={false}
                            showPreview={true}
                          />
                        )}

                        {/* Advance days */}
                        <div className="space-y-2">
                          <div className="flex items-center gap-4">
                            <Label className="text-sm font-medium">
                              Nh·∫Øc tr∆∞·ªõc/sau:
                            </Label>
                            <div className="flex items-center gap-2">
                              <Input
                                type="number"
                                value={notification.advanceDays}
                                onChange={(e) => {
                                  const newValue = Number(e.target.value);
                                  setNotifications((prev) => {
                                    const copy = [...prev];
                                    copy[index] = {
                                      ...copy[index],
                                      advanceDays: newValue,
                                    };
                                    return copy;
                                  });
                                }}
                                className="w-20 h-8"
                                placeholder="0"
                              />
                              <span className="text-sm text-muted-foreground">
                                ng√†y
                              </span>
                            </div>
                          </div>

                          {/* Ch√∫ th√≠ch cho advance days */}
                          <div className="text-xs text-muted-foreground px-3 space-y-1">
                            <div className="flex items-center gap-2">
                              <span>üí°</span>
                              <span>
                                <strong>S·ªë d∆∞∆°ng (+)</strong>: Nh·∫Øc tr∆∞·ªõc ng√†y
                                s·ª± ki·ªán
                              </span>
                            </div>
                            <div className="flex items-center gap-2 ml-6">
                              <span>üìÖ</span>
                              <span>V√≠ d·ª•: +3 = nh·∫Øc tr∆∞·ªõc 3 ng√†y</span>
                            </div>
                            <div className="flex items-center gap-2">
                              <span>üîî</span>
                              <span>
                                <strong>S·ªë √¢m (-)</strong>: Nh·∫Øc sau ng√†y s·ª±
                                ki·ªán
                              </span>
                            </div>
                            <div className="flex items-center gap-2 ml-6">
                              <span>üìÖ</span>
                              <span>
                                V√≠ d·ª•: -7 = nh·∫Øc sau 7 ng√†y (gi·ªó l·∫ßn th·ª© 7)
                              </span>
                            </div>
                            <div className="flex items-center gap-2">
                              <span>üéØ</span>
                              <span>
                                <strong>S·ªë 0</strong>: Nh·∫Øc ƒë√∫ng ng√†y s·ª± ki·ªán
                              </span>
                            </div>
                          </div>
                        </div>

                        {/* Preview notification date */}
                        <div className="p-3 bg-muted/30 rounded-lg">
                          <p className="text-sm text-muted-foreground">
                            {notification.advanceDays > 0 ? (
                              <>
                                üîî S·∫Ω nh·∫Øc tr∆∞·ªõc {notification.advanceDays} ng√†y
                                v√†o:{" "}
                              </>
                            ) : notification.advanceDays < 0 ? (
                              <>
                                üîî S·∫Ω nh·∫Øc sau{" "}
                                {Math.abs(notification.advanceDays)} ng√†y
                                v√†o:{" "}
                              </>
                            ) : (
                              <>üîî S·∫Ω nh·∫Øc ƒë√∫ng ng√†y s·ª± ki·ªán v√†o: </>
                            )}
                            <span className="font-medium text-foreground">
                              {format(notificationDate, "dd/MM/yyyy")}
                            </span>
                          </p>

                          {/* Hi·ªÉn th·ªã ng√†y t∆∞∆°ng ƒë∆∞∆°ng (√¢m/d∆∞∆°ng) cho notification date */}
                          <div className="mt-1 text-xs text-muted-foreground ml-6">
                            {(() => {
                              try {
                                const lunarConverted =
                                  LunarService.convertSolarToLunar(
                                    notificationDate
                                  );
                                return (
                                  <div className="flex items-center gap-2 text-purple-600 dark:text-purple-400">
                                    <span>‚Ü≥ üåô</span>
                                    <span>
                                      T∆∞∆°ng ƒë∆∞∆°ng: {lunarConverted.day}/
                                      {lunarConverted.month} √Çm l·ªãch
                                      {lunarConverted.isLeapMonth
                                        ? " (nhu·∫≠n)"
                                        : ""}
                                    </span>
                                  </div>
                                );
                              } catch {
                                return (
                                  <div className="flex items-center gap-2 text-orange-600 dark:text-orange-400">
                                    <span>‚ö†Ô∏è</span>
                                    <span>
                                      Kh√¥ng th·ªÉ chuy·ªÉn ƒë·ªïi sang √¢m l·ªãch
                                    </span>
                                  </div>
                                );
                              }
                            })()}
                          </div>

                          {/* Hint text v·ªÅ logic t√≠nh to√°n */}
                          <div className="mt-2 text-xs text-muted-foreground space-y-1">
                            {!notification.isCustomDateEnabled ? (
                              // Logic cho event date g·ªëc
                              <>
                                {eventInfo.isLunar ? (
                                  notification.isYearlyLunarRepeat ? (
                                    <p className="flex items-center gap-1">
                                      <span>üåô</span>
                                      <span>
                                        L·∫∑p l·∫°i h√†ng nƒÉm ‚Üí d√πng ng√†y √¢m s·∫Øp ƒë·∫øn
                                        (kh√¥ng nhu·∫≠n)
                                      </span>
                                    </p>
                                  ) : (
                                    <p className="flex items-center gap-1">
                                      <span>üóìÔ∏è</span>
                                      <span>
                                        Kh√¥ng l·∫∑p l·∫°i ‚Üí d√πng ng√†y d∆∞∆°ng ƒë√£
                                        convert
                                      </span>
                                    </p>
                                  )
                                ) : notification.isYearlyLunarRepeat ? (
                                  <p className="flex items-center gap-1">
                                    <span>üîÑ</span>
                                    <span>
                                      L·∫∑p l·∫°i h√†ng nƒÉm ‚Üí convert sang √¢m r·ªìi
                                      t√≠nh g·∫ßn nh·∫•t
                                    </span>
                                  </p>
                                ) : (
                                  <p className="flex items-center gap-1">
                                    <span>üìÖ</span>
                                    <span>
                                      Kh√¥ng l·∫∑p l·∫°i ‚Üí d√πng ng√†y d∆∞∆°ng g·ªëc
                                    </span>
                                  </p>
                                )}
                              </>
                            ) : (
                              // Logic cho custom date
                              <p className="flex items-center gap-1">
                                <span>‚öôÔ∏è</span>
                                <span>Ng√†y t√πy ch·ªânh v·ªõi logic t∆∞∆°ng t·ª±</span>
                              </p>
                            )}
                          </div>
                        </div>

                        {/* Note input */}
                        <div>
                          <Label className="text-sm font-medium">
                            Ghi ch√∫ th√¥ng b√°o:
                          </Label>
                          <Input
                            value={notification.note}
                            onChange={(e) => {
                              setNotifications((prev) => {
                                const copy = [...prev];
                                copy[index] = {
                                  ...copy[index],
                                  note: e.target.value,
                                };
                                return copy;
                              });
                            }}
                            placeholder="V√≠ d·ª•: ƒê·ª´ng qu√™n mua hoa, b√°nh ch∆∞ng..."
                            className="mt-1"
                          />
                        </div>
                      </div>
                    </div>
                  );
                })
              )}
            </div>

            {error && <p className="text-sm text-red-500">{error}</p>}

            <div className="flex gap-3 pt-4">
              <Button
                type="button"
                variant="outline"
                onClick={onBack}
                className="flex-1"
                disabled={loading}
              >
                <ArrowLeft className="h-4 w-4 mr-2" />
                Quay l·∫°i
              </Button>
              <Button
                type="button"
                onClick={handleSave}
                className="flex-1"
                disabled={loading}
              >
                <Save className="h-4 w-4 mr-2" />
                {loading ? "ƒêang l∆∞u..." : "Ho√†n th√†nh"}
              </Button>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
